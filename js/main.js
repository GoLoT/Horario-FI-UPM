var cursos = {
  "1M": {
    "color": "rgba(255, 0, 0, 0.3)",
    "AL": {
      "name": "Álgebra Lineal",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 1
        },
        {
          "duration": 2,
          "start": 3,
          "day": 2
        }
      ],
      "ects": 6
    },
    "FFTI": {
      "name": "Fundamentos Físicos y Tecnológicos de la Informática",
      "calname": "undefined",
      "hours": [{
          "duration": 1,
          "start": 5,
          "day": 2
        },
        {
          "duration": 2,
          "start": 1,
          "day": 4
        },
        {
          "duration": 2,
          "start": 3,
          "day": 5
        }
      ],
      "ects": 6
    },
    "LOG": {
      "name": "Lógica",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 1
        },
        {
          "duration": 2,
          "start": 1,
          "day": 3
        }
      ],
      "ects": 6
    },
    "Prog1": {
      "name": "Programación 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 2
        },
        {
          "duration": 2,
          "start": 3,
          "day": 3
        }
      ],
      "ects": 6
    },
    "MD1": {
      "name": "Matemática Discreta 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 4
        },
        {
          "duration": 1,
          "start": 5,
          "day": 3
        },
        {
          "duration": 2,
          "start": 1,
          "day": 5
        },
      ],
      "ects": 6
    }
  },
  "2M": {
    "color": "rgba(255, 60, 0, 0.3)",
    "AL": {
      "name": "Álgebra Lineal",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 3
        },
        {
          "duration": 2,
          "start": 3,
          "day": 4
        }
      ],
      "ects": 6
    },
    "FFTI": {
      "name": "Fundamentos Físicos y Tecnológicos de la Informática",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 1
        },
        {
          "duration": 2,
          "start": 3,
          "day": 2
        }, {
          "duration": 1,
          "start": 5,
          "day": 4
        }
      ],
      "ects": 6
    },
    "LOG": {
      "name": "Lógica",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 3
        },
        {
          "duration": 2,
          "start": 1,
          "day": 5
        }
      ],
      "ects": 6
    },
    "Prog1": {
      "name": "Programación 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 4
        },
        {
          "duration": 2,
          "start": 3,
          "day": 5
        }
      ],
      "ects": 6
    },
    "MD1": {
      "name": "Matemática Discreta 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 1
        },
        {
          "duration": 2,
          "start": 1,
          "day": 2
        },
        {
          "duration": 1,
          "start": 5,
          "day": 3
        }
      ],
      "ects": 6
    }
  },
  "3M": {
    "color": "rgba(255, 120, 0, 0.3)",
    "AL": {
      "name": "Álgebra Lineal",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 4
        },
        {
          "duration": 2,
          "start": 3,
          "day": 5
        }
      ],
      "ects": 6
    },
    "FFTI": {
      "name": "Fundamentos Físicos y Tecnológicos de la Informática",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 2
        },
        {
          "duration": 2,
          "start": 3,
          "day": 3
        }, {
          "duration": 1,
          "start": 5,
          "day": 4
        }
      ],
      "ects": 6
    },
    "LOG": {
      "name": "Lógica",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 4
        },
        {
          "duration": 2,
          "start": 1,
          "day": 1
        }
      ],
      "ects": 6
    },
    "Prog1": {
      "name": "Programación 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 5
        },
        {
          "duration": 2,
          "start": 3,
          "day": 1
        }
      ],
      "ects": 6
    },
    "MD1": {
      "name": "Matemática Discreta 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 2
        },
        {
          "duration": 2,
          "start": 1,
          "day": 3
        },
        {
          "duration": 1,
          "start": 5,
          "day": 5
        },
      ],
      "ects": 6
    }
  },
  "4M": {
    "color": "rgba(255, 180, 0, 0.3)",
    "AL": {
      "name": "Álgebra Lineal",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 2
        },
        {
          "duration": 2,
          "start": 3,
          "day": 3
        }
      ],
      "ects": 6
    },
    "FFTI": {
      "name": "Fundamentos Físicos y Tecnológicos de la Informática",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 5
        },
        {
          "duration": 2,
          "start": 3,
          "day": 1
        }, {
          "duration": 1,
          "start": 5,
          "day": 3
        }
      ],
      "ects": 6
    },
    "LOG": {
      "name": "Lógica",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 3
        },
        {
          "duration": 2,
          "start": 1,
          "day": 5
        }
      ],
      "ects": 6
    },
    "Prog1": {
      "name": "Programación 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 1,
          "day": 4
        },
        {
          "duration": 2,
          "start": 3,
          "day": 5
        }
      ],
      "ects": 6
    },
    "MD1": {
      "name": "Matemática Discreta 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 3,
          "day": 1
        },
        {
          "duration": 2,
          "start": 1,
          "day": 2
        },
        {
          "duration": 1,
          "start": 5,
          "day": 3
        }
      ],
      "ects": 6
    }
  },
  "5T": {
    "color": "rgba(255, 240, 0, 0.3)",
    "AL": {
      "name": "Álgebra Lineal",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 7,
          "day": 1
        },
        {
          "duration": 2,
          "start": 9,
          "day": 3
        }
      ],
      "ects": 6
    },
    "FFTI": {
      "name": "Fundamentos Físicos y Tecnológicos de la Informática",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 9,
          "day": 2
        },
        {
          "duration": 1,
          "start": 11,
          "day": 1
        }, {
          "duration": 2,
          "start": 7,
          "day": 5
        }
      ],
      "ects": 6
    },
    "LOG": {
      "name": "Lógica",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 9,
          "day": 1
        },
        {
          "duration": 2,
          "start": 8,
          "day": 4
        }
      ],
      "ects": 6
    },
    "Prog1": {
      "name": "Programación 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 10,
          "day": 4
        },
        {
          "duration": 2,
          "start": 7,
          "day": 3
        }
      ],
      "ects": 6
    },
    "MD1": {
      "name": "Matemática Discreta 1",
      "calname": "undefined",
      "hours": [{
          "duration": 2,
          "start": 7,
          "day": 2
        },
        {
          "duration": 2,
          "start": 9,
          "day": 5
        },
        {
          "duration": 1,
          "start": 11,
          "day": 3
        }
      ],
      "ects": 6
    }
  },
  "8F1T": {
    "color": "rgba(0, 255, 180, 0.3)",
    "GPTI": {
      "name": "Gestión de Procesos de Tecnologías de la información",
      "calname": "GPTI",
      "hours": [{
          "duration": 1,
          "start": 7,
          "day": 1
        },
        {
          "duration": 2,
          "start": 7,
          "day": 5
        }
      ],
      "ects": 6,
      "aula": 6105
    },
    "IS2": {
      "name": "Ingeniería del Software II",
      "calname": "IS2",
      "hours": [{
          "duration": 1,
          "start": 8,
          "day": 1
        },
        {
          "duration": 2,
          "start": 7,
          "day": 3
        }
      ],
      "ects": 6,
      "aula": 6105
    },
    "EPAC": {
      "name": "English for Professional and Academic Communication ",
      "calname": "EPAC",
      "hours": [{
          "duration": 2,
          "start": 8,
          "day": 2
        },
        {
          "duration": 2,
          "start": 8,
          "day": 4
        }
      ],
      "ects": 6,
      "aula": 6105
    }
  },
  "OPT4": {
    "color": "rgba(0, 255, 240, 0.3)",
    "TC": {
      "name": "Computabilidad: Fundamentos y Aplicaciones",
      "calname": "TC",
      "hours": [{
        "duration": 2,
        "start": 9,
        "day": 1
      }],
      "ects": 3,
      "aula": 0
    },
    "ADW": {
      "name": "Arquitectura del Data Warehouse",
      "calname": "ADW",
      "hours": [{
        "duration": 2,
        "start": 9,
        "day": 1
      }],
      "ects": 3
    },
    "AlGe": {
      "name": "Algoritmos Geométricos",
      "calname": "AlGe",
      "hours": [{
        "duration": 2,
        "start": 6,
        "day": 2
      }],
      "ects": 3,
      "aula": 0
    },
    "MdD": {
      "name": "Minería de Datos",
      "calname": "MdD",
      "hours": [{
        "duration": 2,
        "start": 6,
        "day": 2
      }],
      "ects": 3,
      "aula": 0
    },
    "RPC": {
      "name": "Robótica y Percepción Computacional",
      "calname": "RPC",
      "hours": [{
        "duration": 2,
        "start": 10,
        "day": 2
      }],
      "ects": 3,
      "aula": 0
    },
    "CAR": {
      "name": "Computación de Alto Rendimiento",
      "calname": "CAR",
      "hours": [{
        "duration": 2,
        "start": 10,
        "day": 2
      }],
      "ects": 3,
      "aula": 0
    },
    "SDFC": {
      "name": "Sistemas Dinámicos, Fractales y Caos",
      "calname": "SDFC",
      "hours": [{
          "duration": 2,
          "start": 5,
          "day": 3
        },
        {
          "duration": 2,
          "start": 6,
          "day": 4
        }
      ],
      "ects": 6,
      "aula": 0
    },
    "G3DIG": {
      "name": "Geometría 3D para informática Gráfica",
      "calname": "G3DIG",
      "hours": [{
        "duration": 2,
        "start": 9,
        "day": 3
      }],
      "ects": 3,
      "aula": 0
    },
    "ABV": {
      "name": "Aplicaciones de la Biometría de la Voz",
      "calname": "ABV",
      "hours": [{
        "duration": 2,
        "start": 9,
        "day": 3
      }],
      "ects": 3,
      "aula": 0
    },
    "I2T": {
      "name": "Ingeniería de Integración Tecnológica",
      "calname": "I2T",
      "hours": [{
        "duration": 2,
        "start": 10,
        "day": 4
      }],
      "ects": 3,
      "aula": 0
    },
    "FC": {
      "name": "Fotografía Computacional",
      "calname": "FC",
      "hours": [{
        "duration": 2,
        "start": 5,
        "day": 5
      }],
      "ects": 3,
      "aula": 0
    },
    "DAW": {
      "name": "Diseño de Aplicaciones Web",
      "calname": "DAW",
      "hours": [{
        "duration": 2,
        "start": 9,
        "day": 5
      }],
      "ects": 3,
      "aula": 0
    }
  }
}


var numcredits = 0;
var nasignaturas = 0;

function toggleAsignatura(event) {
  if (control)
    redrawCanvas();
}

function popList() {
  var ctrldiv = document.getElementById("controls");
  for (var c in cursos) {
    var curso = cursos[c];
    var d = document.createElement("div");
    d.style.backgroundColor = curso["color"];
    var s = document.createElement("span");
    s.appendChild(document.createTextNode(c + ":"));
    s.style.width = "70px";
    s.style.float = "left";
    d.appendChild(s);
    for (var a in curso) {
      if (a == "color") continue;
      var label = document.createElement("label");
      var cb = document.createElement("input");
      cb.type = "checkbox";
      cb.name = a;
      cb.value = c;
      cb.id = c + "." + a;
      cb.onchange = function() {
        toggleAsignatura(this)
      };
      label.appendChild(cb);
      label.appendChild(document.createTextNode(curso[a].name));
      d.appendChild(label);
    }
    ctrldiv.appendChild(d);
  }
  if (window.location.hash) {
    setInputFromString(window.location.hash.substring(1));
  }
  redrawCanvas();
  control = true;
}

function setInputFromString(str) {
  var originalHash = window.location.hash;
  if (originalHash.startsWith("#A="))
    originalHash = originalHash.substring(3, originalHash.length);
  else
    originalHash = originalHash.substring(1, originalHash.length);
  var urlArr = originalHash.split(",");
  for (elem in urlArr) {
    if (!urlArr[elem]) continue;
    console.log(urlArr[elem]);
    var togleButton = document.getElementById(urlArr[elem]);
    var dataElem = urlArr[elem].split(".");
    togleButton.checked = true;
  }
}

var calcanvas;
var canvasctx;

function redrawCanvas() {
  calcanvas = document.getElementById("calcanvas");
  canvasctx = calcanvas.getContext("2d");
  var cbs = document.getElementById("controls").getElementsByTagName("input");
  var curso, asignatura, numcredits = 0,
    nasignaturas = 0;

  canvasctx.clearRect(0, 0, calcanvas.width, calcanvas.height);
  canvasctx.rect(0, 0, calcanvas.width, calcanvas.height);
  canvasctx.fillStyle = "white";
  canvasctx.fill();
  var blockheight = calcanvas.height / 6;
  var blockwidth = calcanvas.width / 12;
  var blockleft, blockright, blockup;
  canvasctx.lineWidth = "1";

  canvasctx.strokeStyle = 'rgba(0, 0, 0, 0.25)';
  canvasctx.setLineDash([4, 15]);
  canvasctx.fillStyle = "black";
  canvasctx.beginPath();
  for (var i = 1; i < 12; i++) {
    canvasctx.moveTo(blockwidth * i, blockheight);
    canvasctx.lineTo(blockwidth * i, calcanvas.height);
  }
  for (var i = 2; i < 6; i++) {
    canvasctx.moveTo(0, blockheight * i);
    canvasctx.lineTo(calcanvas.width, blockheight * i);
  }
  canvasctx.stroke();

  canvasctx.beginPath();
  canvasctx.setLineDash([1, 0]);
  canvasctx.strokeStyle = "black";
  canvasctx.fillStyle = "black";
  canvasctx.font = "20px Arial";
  canvasctx.textAlign = 'center';
  canvasctx.rect(0, 0, calcanvas.width - 1, calcanvas.height - 1);
  for (i = 0; i < 12; i++) {
    blockleft = i * blockwidth;
    blockright = (i + 1) * blockwidth;
    canvasctx.rect(blockleft, 0, blockright, blockheight);
    canvasctx.fillText((9 + i) + ":00 - " + (10 + i) + ":00", blockleft + blockwidth / 2, blockheight / 1.7);
  }
  canvasctx.stroke();

  var ects, c, hours, urlPlus = "A=";
  for (var i = 0; i < cbs.length; i++) {
    if (!cbs[i].checked) continue;
    curso = cbs[i].value;
    asignatura = cbs[i].name;
    ects = cursos[curso][asignatura].ects;
    c = cursos[curso];
    hours = c[asignatura]["hours"];
    numcredits += ects;
    nasignaturas++;
    urlPlus += curso + "." + asignatura + ",";
    lineHeight = document.getElementById("showGroup").checked || document.getElementById("showClass").checked ? blockheight / 2.5 : blockheight / 1.7;

    for (var j = 0; j < hours.length; j++) {
      blockup = (hours[j]["day"]) * blockheight;
      blockleft = (hours[j]["start"] - 1) * blockwidth;
      canvasctx.fillStyle = c["color"];
      canvasctx.fillRect(blockleft, blockup, blockwidth * hours[j]["duration"], blockheight);
      canvasctx.strokeStyle = 'rgba(0, 0, 0, 0.35)';
      canvasctx.rect(blockleft, blockup, blockwidth * hours[j]["duration"], blockheight);
      canvasctx.stroke();
      canvasctx.fillStyle = "black";
      canvasctx.strokeStyle = "black";
      canvasctx.fillText((!c[asignatura].calname || (c[asignatura].calname == "undefined")) ? c[asignatura].name : c[asignatura].calname, blockleft + blockwidth * hours[j]["duration"] / 2, blockup + lineHeight);
      if (document.getElementById("showGroup").checked || document.getElementById("showClass").checked) {
        canvasctx.fillText("( " + (document.getElementById("showGroup").checked ? curso : "") + (document.getElementById("showGroup").checked && document.getElementById("showClass").checked ? " / " : "") + (document.getElementById("showClass").checked ? c[asignatura]["aula"] : "") + " )", blockleft + blockwidth * hours[j]["duration"] / 2, blockup + blockheight / 1.2);
      }
    }

  }
  if (urlPlus.endsWith(","))
    urlPlus = urlPlus.substr(0, urlPlus.length - 1)
  window.location.hash = urlPlus == "A=" ? "" : urlPlus;
  savePNG();

  document.getElementById("ncreditos").innerHTML = numcredits;
  document.getElementById("nasignaturas").innerHTML = nasignaturas;
}

function savePNG() {
  var img = calcanvas.toDataURL("image/png");
  document.getElementById("pnglink").href = img;
}
