var cursos = {
    "1M" : {
        "color": "rgba(255, 0, 0, 0.3)",
        "IPO": {
            "name": "Interacción Persona-Ordenador",
            "hours": [
                {"duration": 2, "start": 1, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects":6
        },
        "AGE": {
            "name": "Administración y Gestión de Empresas",
            "hours": [
                {"duration": 1, "start": 2, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects": 6
        },
        "PYE1": {
            "name": "Probabilidad y Estadística I",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 3, "day": 4}],
            "ects": 6
        },
        "SSDD": {
            "name": "Sistemas digitales",
            "hours": [
                {"duration": 2, "start": 1, "day": 2},
                {"duration": 2, "start": 1, "day": 4}],
            "ects": 6
        },
        "Calc": {
            "name": "Cálculo",
            "hours": [
                {"duration": 2, "start": 3, "day": 2},
                {"duration": 1, "start": 5, "day": 4},
                {"duration": 2, "start": 1, "day": 5}],
            "ects": 6
        },
        "ProgII": {
            "name": "Programación II",
            "hours": [
                {"duration": 2, "start": 1, "day": 3},
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 6
        }
    },
    "2M" : {
        "color": "rgba(255, 60, 0, 0.3)",
        "IPO": {
            "name": "Interacción Persona-Ordenador",
            "hours": [
                {"duration": 2, "start": 1, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects":6
        },
        "AGE": {
            "name": "Administración y Gestión de Empresas",
            "hours": [
                {"duration": 1, "start": 2, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects": 6
        },
        "PYE1": {
            "name": "Probabilidad y Estadística I",
            "hours": [
                {"duration": 2, "start": 3, "day": 4},
                {"duration": 2, "start": 1, "day": 5}],
            "ects": 6
        },
        "SSDD-I": {
            "name": "Sistemas digitales [Inglés]",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 1, "day": 3}],
            "ects": 6
        },
        "Calc-I": {
            "name": "Cálculo [Inglés]",
            "hours": [
                {"duration": 2, "start": 1, "day": 2},
                {"duration": 1, "start": 5, "day": 4},
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 6
        },
        "ProgII": {
            "name": "Programación II",
            "hours": [
                {"duration": 2, "start": 3, "day": 2},
                {"duration": 2, "start": 1, "day": 4}],
            "ects": 6
        }
    },
    "3M" : {
        "color": "rgba(255, 120, 0, 0.3)",
        "IPO": {
            "name": "Interacción Persona-Ordenador",
            "hours": [
                {"duration": 2, "start": 1, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects":6
        },
        "AGE": {
            "name": "Administración y Gestión de Empresas",
            "hours": [
                {"duration": 1, "start": 2, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects": 6
        },
        "PYE1": {
            "name": "Probabilidad y Estadística I",
            "hours": [
                {"duration": 2, "start": 1, "day": 2},
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 6
        },
        "SSDD": {
            "name": "Sistemas digitales",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 1, "day": 4}],
            "ects": 6
        },
        "Calc": {
            "name": "Cálculo",
            "hours": [
                {"duration": 2, "start": 3, "day": 2},
                {"duration": 2, "start": 1, "day": 3},
                {"duration": 1, "start": 5, "day": 4}],
            "ects": 6
        },
        "ProgII": {
            "name": "Programación II",
            "hours": [
                {"duration": 2, "start": 3, "day": 4},
                {"duration": 2, "start": 1, "day": 5}],
            "ects": 6
        }
    },
    "4M" : {
        "color": "rgba(255, 180, 0, 0.3)",
        "IPO": {
            "name": "Interacción Persona-Ordenador",
            "hours": [
                {"duration": 2, "start": 1, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects":6
        },
        "AGE": {
            "name": "Administración y Gestión de Empresas",
            "hours": [
                {"duration": 1, "start": 2, "day": 1},
                {"duration": 2, "start": 3, "day": 3}],
            "ects": 6
        },
        "PYE1": {
            "name": "Probabilidad y Estadística I",
            "hours": [
                {"duration": 2, "start": 1, "day": 4},
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 6
        },
        "SSDD": {
            "name": "Sistemas digitales",
            "hours": [
                {"duration": 2, "start": 3, "day": 4},
                {"duration": 2, "start": 1, "day": 5}],
            "ects": 6
        },
        "Calc": {
            "name": "Cálculo",
            "hours": [
                {"duration": 1, "start": 5, "day": 1},
                {"duration": 2, "start": 3, "day": 2},
                {"duration": 2, "start": 1, "day": 3}],
            "ects": 6
        },
        "ProgII": {
            "name": "Programación II",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 2, "day": 2}],
            "ects": 6
        }
    },
    "5T" : {
        "color": "rgba(255, 240, 0, 0.3)",
        "IPO": {
            "name": "Interacción Persona-Ordenador",
            "hours": [
                {"duration": 2, "start": 9, "day": 2},
                {"duration": 2, "start": 6, "day": 5}],
            "ects":6
        },
        "PYE1": {
            "name": "Probabilidad y Estadística I",
            "hours": [
                {"duration": 2, "start": 7, "day": 4},
                {"duration": 2, "start": 7, "day": 5}],
            "ects": 6
        },
        "SSDD": {
            "name": "Sistemas digitales",
            "hours": [
                {"duration": 2, "start": 7, "day": 1},
                {"duration": 2, "start": 9, "day": 3}],
            "ects": 6
        },
        "Calc": {
            "name": "Cálculo",
            "hours": [
                {"duration": 1, "start": 6, "day": 2},
                {"duration": 2, "start": 7, "day": 3},
                {"duration": 2, "start": 9, "day": 4}],
            "ects": 6
        },
        "ProgII": {
            "name": "Programación II",
            "hours": [
                {"duration": 2, "start": 9, "day": 1},
                {"duration": 2, "start": 7, "day": 2}],
            "ects": 6
        }
    },
    "4F1M" : {
        "color": "rgba(180, 255, 0, 0.3)",
        "AC": {
            "name": "Arquitectura de Computadores",
            "hours": [
                {"duration": 1, "start": 1, "day": 1},
                {"duration": 2, "start": 1, "day": 3},
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 6
        },
        "Concu": {
            "name": "Concurrencia",
            "hours": [
                {"duration": 1, "start": 2, "day": 1},
                {"duration": 1, "start": 5, "day": 2}],
            "ects": 3
        },
        "SSOO": {
            "name": "Sistemas Operativos",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 1, "day": 4}],
            "ects": 6
        },
        "FEAE": {
            "name": "Fundamentos de Economía y Administración de Empresas",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 1, "day": 4}],
            "ects": 3
        },
        "RdC": {
            "name": "Redes de Computadores",
            "hours": [
                {"duration": 1, "start": 5, "day": 1},
                {"duration": 2, "start": 3, "day": 2},
                {"duration": 2, "start": 1, "day": 5}],
            "ects": 6
        },
        "PyEII": {
            "name": "Probabilidad y Estadística II",
            "hours": [
                {"duration": 2, "start": 1, "day": 2}],
            "ects": 3
        },
        "BBDD": {
            "name": "Bases de Datos",
            "hours": [
                {"duration": 2, "start": 3, "day": 3},
                {"duration": 2, "start": 3, "day": 4}],
            "ects": 3
        }
    },
    "4F2M" : {
        "color": "rgba(120, 255, 0, 0.3)",
        "AC": {
            "name": "Arquitectura de Computadores",
            "hours": [
                {"duration": 1, "start": 5, "day": 1},
                {"duration": 2, "start": 1, "day": 2},
                {"duration": 2, "start": 3, "day": 4}],
            "ects": 6
        },
        "Concu": {
            "name": "Concurrencia",
            "hours": [
                {"duration": 1, "start": 5, "day": 3},
                {"duration": 1, "start": 2, "day": 4}],
            "ects": 3
        },
        "FEAE": {
            "name": "Fundamentos de Economía y Administración de Empresas",
            "hours": [
                {"duration": 2, "start": 1, "day": 1},
                {"duration": 2, "start": 1, "day": 5}],
            "ects": 3
        },
        "RdC": {
            "name": "Redes de Computadores",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 3, "day": 3},
                {"duration": 2, "start": 5, "day": 4}],
            "ects": 6
        },
        "PyEII": {
            "name": "Probabilidad y Estadística II",
            "hours": [
                {"duration": 2, "start": 3, "day": 2}],
            "ects": 3
        },
        "BBDD": {
            "name": "Bases de Datos",
            "hours": [
                {"duration": 2, "start": 1, "day": 3},
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 3
        }
    },
    "4F3T" : {
        "color": "rgba(60, 255, 0, 0.3)",
        "AC": {
            "name": "Arquitectura de Computadores",
            "hours": [
                {"duration": 2, "start": 7, "day": 1},
                {"duration": 2, "start": 7, "day": 3},
                {"duration": 1, "start": 6, "day": 4}],
            "ects": 6
        },
        "Concu": {
            "name": "Concurrencia",
            "hours": [
                {"duration": 1, "start": 9, "day": 1},
                {"duration": 2, "start": 6, "day": 2}],
            "ects": 3
        },
        "FEAE": {
            "name": "Fundamentos de Economía y Administración de Empresas",
            "hours": [
                {"duration": 2, "start": 7, "day": 4},
                {"duration": 2, "start": 8, "day": 5}],
            "ects": 3
        },
        "RdC": {
            "name": "Redes de Computadores",
            "hours": [
                {"duration": 2, "start": 9, "day": 1},
                {"duration": 1, "start": 6, "day": 3},
                {"duration": 2, "start": 6, "day": 5}],
            "ects": 6
        },
        "PyEII": {
            "name": "Probabilidad y Estadística II",
            "hours": [
                {"duration": 2, "start": 7, "day": 2}],
            "ects": 3
        },
        "BBDD": {
            "name": "Bases de Datos",
            "hours": [
                {"duration": 2, "start": 9, "day": 3},
                {"duration": 2, "start": 9, "day": 4}],
            "ects": 3
        }
    },
    "6F1M" : {
        "color": "rgba(0, 255, 0, 0.3)",
        "SSDist": {
            "name": "Sistemas Distribuidos",
            "hours": [
                {"duration": 2, "start": 1, "day": 1},
                {"duration": 2, "start": 3, "day": 4}],
            "ects": 6
        },
        "IS1": {
            "name": "Ingeniería de Software I",
            "hours": [
                {"duration": 2, "start": 3, "day": 1},
                {"duration": 2, "start": 1, "day": 3}],
            "ects": 6
        },
        "SOS": {
            "name": "Sistemas Orientados a Servicios",
            "hours": [
                {"duration": 2, "start": 3, "day": 2},
                {"duration": 2, "start": 3, "day": 3}],
            "ects": 6
        },
        "PDLR": {
            "name": "Programación Declarativa: Lógica y Restricciones",
            "hours": [
                {"duration": 2, "start": 1, "day": 4}],
            "ects": 3
        },
        "PII": {
            "name": "Proyecto de Instalación Informática",
            "hours": [
                {"duration": 2, "start": 3, "day": 5}],
            "ects": 3
        }
    },
    "6F2T" : {
        "color": "rgba(0, 255, 60, 0.3)",
        "SSDist": {
            "name": "Sistemas Distribuidos",
            "hours": [
                {"duration": 2, "start": 8, "day": 1},
                {"duration": 2, "start": 8, "day": 4}],
            "ects": 6
        },
        "IS1": {
            "name": "Ingeniería de Software I",
            "hours": [
                {"duration": 2, "start": 10, "day": 2},
                {"duration": 2, "start": 10, "day": 4}],
            "ects": 6
        },
        "SOS": {
            "name": "Sistemas Orientados a Servicios",
            "hours": [
                {"duration": 2, "start": 10, "day": 1},
                {"duration": 2, "start": 10, "day": 3}],
            "ects": 6
        },
        "PDLR": {
            "name": "Programación Declarativa: Lógica y Restricciones",
            "hours": [
                {"duration": 2, "start": 8, "day": 3}],
            "ects": 3
        },
        "PII": {
            "name": "Proyecto de Instalación Informática",
            "hours": [
                {"duration": 2, "start": 8, "day": 3}],
            "ects": 3
        }
    },
    "OPT3" : {
        "color": "rgba(0, 255, 120, 0.3)",
        "PDDS": {
            "name": "Procesamiento Digital de la Señal",
            "hours": [
                {"duration": 2, "start": 6, "day": 1},
                {"duration": 2, "start": 6, "day": 3}],
            "ects": 6
        },
        "SSII": {
            "name": "Sistemas Inteligentes",
            "hours": [
                {"duration": 2, "start": 6, "day": 1},
                {"duration": 2, "start": 6, "day": 3}],
            "ects": 6
        },
        "ATID": {
            "name": "Algoritmos Topológicos para Imágenes Digitales",
            "hours": [
                {"duration": 2, "start": 1, "day": 2}],
            "ects": 3
        },
        "TIC": {
            "name": "Teoría de la Información y de la Codificación",
            "hours": [
                {"duration": 2, "start": 6, "day": 2}],
            "ects": 3
        },
        "CCPP": {
            "name": "Computadores Personales",
            "hours": [
                {"duration": 2, "start": 6, "day": 2}],
            "ects": 3
        },
        "TDL": {
            "name": "Traductores de Lenguajes",
            "hours": [
                {"duration": 2, "start": 6, "day": 4}],
            "ects": 3
        },
        "AN2": {
            "name": "ALgorítmica Numérica II",
            "hours": [
                {"duration": 2, "start": 6, "day": 4}],
            "ects": 3
        }
    },
    "8F1T" : {
        "color": "rgba(0, 255, 180, 0.3)",
        "GPTI": {
            "name": "Gestión de Procesos de Tecnologías de la información",
            "hours": [
                {"duration": 1, "start": 7, "day": 1},
                {"duration": 2, "start": 7, "day": 5}],
            "ects": 6
        },
        "IS2": {
            "name": "Ingeniería del Software II",
            "hours": [
                {"duration": 1, "start": 8, "day": 1},
                {"duration": 2, "start": 7, "day": 3}],
            "ects": 6
        },
        "EPAC": {
            "name": "Inglés",
            "hours": [
                {"duration": 2, "start": 8, "day": 2},
                {"duration": 2, "start": 8, "day": 4}],
            "ects": 6
        }
    },
    "OPT4" : {
        "color": "rgba(0, 255, 240, 0.3)",
        "TC": {
            "name": "Teoría de la Computabilidad",
            "hours": [
                {"duration": 2, "start": 9, "day": 1}],
            "ects": 3
        },
        "ADW": {
            "name": "Arquitectura del Data Warehouse",
            "hours": [
                {"duration": 2, "start": 9, "day": 1}],
            "ects": 3
        },
        "AlGe": {
            "name": "Algoritmos Geométricos",
            "hours": [
                {"duration": 2, "start": 6, "day": 2}],
            "ects": 3
        },
        "MdD": {
            "name": "Minería de Datos",
            "hours": [
                {"duration": 2, "start": 6, "day": 2}],
            "ects": 3
        },
        "RPC": {
            "name": "Robótica y Percepción Computacional",
            "hours": [
                {"duration": 2, "start": 10, "day": 2}],
            "ects": 3
        },
        "CAR": {
            "name": "Computación de Alto Rendimiento",
            "hours": [
                {"duration": 2, "start": 10, "day": 2}],
            "ects": 3
        },
        "SDFC": {
            "name": "Sistemas Dinámicos, Fractales y Caos",
            "hours": [
                {"duration": 2, "start": 5, "day": 3},
                {"duration": 2, "start": 6, "day": 4}],
            "ects": 6
        },
        "G3DIG": {
            "name": "Geometría 3D para informática Gráfica",
            "hours": [
                {"duration": 2, "start": 9, "day": 3}],
            "ects": 3
        },
        "ABV": {
            "name": "Aplicaciones de la Biometría de la Voz",
            "hours": [
                {"duration": 2, "start": 9, "day": 3}],
            "ects": 3
        },
        "I2T": {
            "name": "Ingeniería de Integración Tecnológica",
            "hours": [
                {"duration": 2, "start": 10, "day": 4}],
            "ects": 3
        },
        "FC": {
            "name": "Fotografía Computacional",
            "hours": [
                {"duration": 2, "start": 5, "day": 5}],
            "ects": 3
        },
        "DAW": {
            "name": "Diseño de Aplicaciones Web",
            "hours": [
                {"duration": 2, "start": 9, "day": 5}],
            "ects": 3
        }
    }
}

var numcredits = 0;
var nasignaturas = 0;
function toggleAsignatura(event){
    var curso = event.value;
    var asignatura = event.name;
    if(event.checked) {
        showBlock(curso, asignatura);
    } else {
        hideBlock(curso, asignatura);
    }
    updateValues();
}

function hideBlock(curso, asignatura) {
    var ects = cursos[curso][asignatura].ects;
    numcredits -= ects;
    nasignaturas--;
    var c = cursos[curso];
    var hours = c[asignatura]["hours"];
    for(var i=0;i<hours.length;i++) {
        var d = document.getElementById(curso + asignatura + hours[i]["start"] + hours[i]["day"]);
        d.parentNode.removeChild(d);
    }
    var arrUrl = window.location.hash.split(",");
    var newUrl = arrUrl.splice(0,arrUrl.length-2);
    if(newUrl.length>0){
        newUrl += ",";
    }
    window.location.hash = newUrl;
}

function showBlock(curso, asignatura) {
    var ects = cursos[curso][asignatura].ects;
    var c = cursos[curso];
    var hours = c[asignatura]["hours"];
    numcredits += ects;
    nasignaturas++;
    for(var i=0;i<hours.length;i++) {
        var bloque = document.createElement("div");
        bloque.style.backgroundColor = c["color"];
        bloque.appendChild(document.createTextNode(c[asignatura].name));
        bloque.id = curso + asignatura + hours[i]["start"] + hours[i]["day"];
        bloque.style.left = ((hours[i]["start"]-1)*8.333) + "%";
        bloque.style.top = ((hours[i]["day"]-1)*20) + "%";
        bloque.style.width = (hours[i]["duration"]*8.333) + "%";
        document.getElementById("calgrid").appendChild(bloque);
    }
    var urlPlus = curso + "." + asignatura + ",";
    if(!window.location.hash.includes(urlPlus)){
        window.location.hash = window.location.hash + urlPlus;
    }
}

function popList() {
    var ctrldiv = document.getElementById("controls");
    for(var c in cursos) {
        var curso = cursos[c];
        var d = document.createElement("div");
        d.style.backgroundColor = curso["color"];
        var s = document.createElement("span");
        s.appendChild(document.createTextNode(c + ":"));
        s.style.width = "70px";
        s.style.float = "left";
        d.appendChild(s);
        for(var a in curso) {
            if(a=="color") continue;
            var label = document.createElement("label");
            var cb = document.createElement("input");
            cb.type = "checkbox";
            cb.name = a;
            cb.value = c;
            cb.id = c + "." + a;
            cb.onchange = function(){ toggleAsignatura(this) };
            label.appendChild(cb);
            label.appendChild(document.createTextNode(curso[a].name));
            d.appendChild(label);
        }
        ctrldiv.appendChild(d);
    }
    if(window.location.hash) {
        setInputFromString(window.location.hash.substring(1));

    }
}

function getHash() {
    var cbs = document.getElementById("controls").getElementsByTagName("input");
    var index, i, b=32, empty=1;
    var array = new Uint32Array(Math.ceil(cbs.length/b));
    for(i=0;i<cbs.length;i++) {
        index = Math.floor(i/b);
        array[index] = array[index] | ((cbs[i].checked?1:0) << (b-1-i%b));
        if(cbs[i].checked) empty=0;
    }
    if(empty) return "";
    return btoa(array);
}

function setInputFromString(str) {
    var originalHash = window.location.hash;
    var urlArr = originalHash.slice(1,-1).split(","); //el slice es para quitar la almohadilla y el ultim
    for (elem in urlArr){
        var togleButton = document.getElementById(urlArr[elem]);
        console.log(togleButton);
        var dataElem = urlArr[elem].split(".");
        showBlock(dataElem[0], dataElem[1]);
        togleButton.checked=true;
    }
    window.location.hash = originalHash;
}

function updateValues(){
    document.getElementById("ncreditos").innerHTML = numcredits;
    document.getElementById("nasignaturas").innerHTML = nasignaturas;
}

$(function() {
    $("#export2PNG").click(function() {
        html2canvas(document.getElementById("cal"), {
            onrendered: function(canvas){
                theCanvas = canvas;
                document.body.appendChild(canvas);
            }
        });
    });
});
